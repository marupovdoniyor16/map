<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞—Ä—Ç–∞ –æ—Ç–µ–ª–µ–π —Å Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

  <style>
    html, body {
  height: 100%;
  margin: 0;
  font-family: "Segoe UI", Roboto, sans-serif;
  background-color: #f3f4f6;
}

#map {
  height: 100%;
  width: 100%;
}

/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ –æ–∫–Ω–æ */
#info {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 20px;
      border-radius: 15px;
      font-size: 15px;
      z-index: 1100;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      color: #334155;
      font-weight: 600;
      max-width: 260px;
      backdrop-filter: saturate(180%) blur(10px);
      transition: opacity 0.3s ease;
      user-select: none;
      pointer-events: none;
    }


        
/* –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */

.control-buttons {
  position: absolute;
  bottom: 90px;
  left: 10px;
  z-index: 1001;
  display: flex;
  flex-direction: row;
  gap: 10px;
  background: rgba(255, 255, 255, 0.95);
  padding: 10px 12px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}


/* –ö–Ω–æ–ø–∫–∏ */
button {
      cursor: pointer;
      padding: 12px 18px;
      font-size: 15px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #4f46e5, #3b82f6);
      color: white;
      font-weight: 700;
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.5);
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

button:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.7);
    }

button:active {
      transform: scale(0.95);
      box-shadow: 0 3px 10px rgba(59, 130, 246, 0.4);
    }

/* –ü–æ–∏—Å–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
.search-panel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(255, 255, 255, 0.97);
      padding: 16px 22px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
      width: 220px;
      font-weight: 600;
      user-select: none;
    }

#searchInput {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  outline: none;
  width: 160px;
  transition: border-color 0.2s;
}

#searchInput:focus {
  border-color: #3b82f6;
}

.control-buttons {
      position: absolute;
      bottom: 90px;
      left: 20px;
      z-index: 1001;
      display: flex;
      gap: 12px;
      background: rgba(255, 255, 255, 0.97);
      padding: 14px 18px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
      transition: opacity 0.4s ease, transform 0.3s ease;
      font-weight: 600;
    }


/* –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ */
#login-container {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.97);
      padding: 20px 24px;
      border-radius: 20px;
      font-size: 15px;
      z-index: 1002;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      text-align: center;
      width: 240px;
      font-weight: 600;
      user-select: none;
      transition: box-shadow 0.3s ease;
    }

#login-container h4 {
  margin: 5px 0 10px;
  color: #374151;
}

#login-container input {
      width: 90%;
      margin-bottom: 14px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 2px solid #cbd5e1;
      outline: none;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      font-weight: 600;
      font-size: 15px;
      color: #334155;
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.07);
    }


#login-container input:focus {
  border-color: #3b82f6;
}

    #login-container button {
      width: 95%;
      margin-top: 8px;
      padding: 12px 0;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 5px 20px rgba(16, 185, 129, 0.6);
      color: white;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
    }


#login-container button:hover {
    transform: translateY(-2px);
  }

  #login-status {
    margin-top: 8px;
    color: #059669;
    font-weight: 500;
    font-size: 13px;
  }
  .hotel-label span {
    background: rgba(255, 255, 255, 0.9);
    color: #1f2937;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
    transform: translateY(-10px);
  }
  #nav-panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      color: #fff;
      padding: 14px 20px;
      font-size: 16px;
      font-weight: 700;
      text-align: center;
      z-index: 1200;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
      user-select: none;
    }

  #nav-panel span {
    font-weight: 600;
  }

  @media (max-width: 600px) {
  html, body {
    font-size: 14px;
  }

  #map {
    height: 100vh;
    width: 100vw;
  }

  /* –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å–≤–µ—Ä—Ö—É */
  #nav-panel {
    font-size: 14px;
    padding: 10px 12px;
    border-radius: 0 0 12px 12px;
  }

  /* –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */
  .control-buttons {
    flex-direction: column;
    bottom: 120px !important;
    left: 10px !important;
    gap: 8px;
    padding: 10px;
    font-size: 14px;
  }

  .control-buttons button {
    padding: 10px 14px;
    font-size: 14px;
  }

  /* –ü–æ–∏—Å–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
  .search-panel {
    width: 90vw;
    max-width: none;
    left: 50%;
    bottom: 8px !important;
    transform: translateX(-50%);
    padding: 12px 16px;
  }

  #searchInput {
    width: 100%;
    font-size: 14px;
    padding: 8px 10px;
  }

  #searchBtn {
    width: 100%;
    font-size: 14px;
    padding: 10px 0;
  }

  /* –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ */
  #login-container {
    width: 90vw;
    max-width: none;
    bottom: 10px !important;
    right: 50%;
    transform: translateX(50%);
    padding: 16px 20px;
    font-size: 14px;
  }

  #login-container input {
    width: 100%;
    font-size: 14px;
    padding: 10px 12px;
  }

  #login-container button {
    width: 100%;
    font-size: 14px;
    padding: 10px 0;
  }

  /* –ú–∞—Ä–∫–µ—Ä –∏ –ø–æ–¥–ø–∏—Å–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
}



  </style>
</head>

<body>
  <div id="map"></div>
  <div id="info" class="info">‚è≥ Waiting for route...</div>
  <div id="nav-panel">
    üöó <span id="nav-instruction">Navigation inactive</span><br>
    üìè <span id="nav-distance">‚Äì</span> | ‚è±Ô∏è <span id="nav-time">‚Äì</span>
  </div>

  <div class="control-buttons">
    <button id="addBtn">‚ûï Add Hotel</button>
    <button id="delBtn">üóë Delete Hotel</button>
  </div>

  <div class="search-panel">
    <input type="text" id="searchInput" placeholder="Search hotel..." style="padding: 5px;" />
    <button id="searchBtn">üîç Search</button>
  </div>

  <!-- Admin Login -->
  <div id="login-container" class="login-container">
    <h4>Admin Login</h4>
    <input type="email" id="email" placeholder="Email" style="width:150px; margin-bottom:5px;"><br>
    <input type="password" id="password" placeholder="Password" style="width:150px; margin-bottom:5px;"><br>
    <button id="login-btn" style="width:160px; padding:5px;">Login</button>
    <button id="logout-btn" style="width:160px; padding:5px; display:none;">Logout</button>
    <p id="login-status" style="margin-top:5px; color:green; font-size:12px;"></p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getDatabase, ref, push, remove, onChildAdded, onChildRemoved, onValue } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDeXC4WPwuwYh82tJe61gdLWBUVPOYjJKQ",
      authDomain: "hotelmapapppc.firebaseapp.com",
      databaseURL: "https://hotelmapapppc-default-rtdb.firebaseio.com",
      projectId: "hotelmapapppc",
      storageBucket: "hotelmapapppc.appspot.com",
      messagingSenderId: "706995119297",
      appId: "1:706995119297:web:706f5c81bb91beefeee040"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Map initialization
    const map = L.map("map").setView([39.66, 66.97], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    const hotelsRef = ref(db, "hotels");
    const hotelMarkers = {};
    let addMode = false, deleteMode = false;
    let userLocation = null, userMarker = null, routingControl = null;

    // --- Add hotel markers ---
    onChildAdded(hotelsRef, (snapshot) => {
      const id = snapshot.key;
      const hotel = snapshot.val();

      const marker = L.marker([hotel.lat, hotel.lon]).addTo(map)
        .bindPopup(`
          <b>${hotel.name}</b><br>${hotel.description || "‚Äî"}<br>
          <button onclick="window.routeTo(${hotel.lat}, ${hotel.lon})">Route</button>
        `);

      const label = L.divIcon({
        className: "hotel-label",
        html: `<span>${hotel.name}</span>`,
        iconSize: [100, 20],
        iconAnchor: [50, 30]
      });

      const labelMarker = L.marker([hotel.lat, hotel.lon], {
        icon: label,
        interactive: false
      }).addTo(map);

      marker.on("click", () => {
        if (deleteMode && confirm(`Delete ${hotel.name}?`)) {
          remove(ref(db, "hotels/" + id));
        }
      });

      hotelMarkers[id] = { main: marker, label: labelMarker };
    });

    onChildRemoved(hotelsRef, (snapshot) => {
      const id = snapshot.key;
      if (hotelMarkers[id]) {
        map.removeLayer(hotelMarkers[id].main);
        map.removeLayer(hotelMarkers[id].label);
        delete hotelMarkers[id];
      }
    });

    // Add hotel
    document.getElementById("addBtn").onclick = () => {
      if (!currentUser) { alert("Please log in as administrator."); return; }
      addMode = true;
      deleteMode = false;
      alert("Click on the map to add a hotel.");
    };

    map.on("click", (e) => {
      if (!addMode) return;
      const name = prompt("Hotel name:");
      if (name) {
        push(hotelsRef, { name, lat: e.latlng.lat, lon: e.latlng.lng, description: "‚Äî" });
      }
      addMode = false;
    });

    document.getElementById("delBtn").onclick = () => {
      if (!currentUser) { alert("Please log in as administrator."); return; }
      deleteMode = true;
      addMode = false;
      alert("Click on a hotel to delete it.");
    };

    // Search
    document.getElementById("searchBtn").onclick = () => {
      const query = document.getElementById("searchInput").value.toLowerCase();
      onValue(hotelsRef, (snapshot) => {
        let found = null;
        snapshot.forEach((child) => {
          const h = child.val();
          if (h.name.toLowerCase().includes(query)) found = h;
        });
        if (found) {
          map.setView([found.lat, found.lon], 16);
        } else alert("Hotel not found");
      });
    };

    // Geolocation tracking
    const personIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/149/149071.png",
      iconSize: [40, 40],
      iconAnchor: [20, 40]
    });

    let firstLocation = true;
    let geoWatchId = null;
    let currentDestination = null;

    function startGeolocationTracking() {
      if (!navigator.geolocation) {
        alert("Your browser does not support geolocation.");
        return;
      }

      geoWatchId = navigator.geolocation.watchPosition(
        (pos) => {
          const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);
          userLocation = latlng;

          if (!userMarker) {
            userMarker = L.marker(latlng, { icon: personIcon })
              .addTo(map)
              .bindPopup("You are here")
              .openPopup();
          } else {
            userMarker.setLatLng(latlng);
          }

          if (firstLocation) {
            map.setView(latlng, 14);

            onValue(hotelsRef, (snapshot) => {
              let nearest = null;
              let minDist = Infinity;

              snapshot.forEach((child) => {
                const hotel = child.val();
                const dist = getDistance(latlng.lat, latlng.lng, hotel.lat, hotel.lon);
                if (dist < minDist) {
                  minDist = dist;
                  nearest = hotel;
                }
              });

              if (nearest) {
                window.routeTo(nearest.lat, nearest.lon);
                L.popup()
                  .setLatLng([nearest.lat, nearest.lon])
                  .setContent(
                    `<b>Nearest hotel:</b><br>${nearest.name}<br>üìç Distance: ${Math.round(minDist)} m`
                  )
                  .openOn(map);
              }
            });

            firstLocation = false;
          }
        },
        (err) => {
          alert("Geolocation error: " + err.message);
        },
        { enableHighAccuracy: true, maximumAge: 1000 }
      );
    }

    function stopGeolocationTracking() {
      if (geoWatchId !== null) {
        navigator.geolocation.clearWatch(geoWatchId);
        geoWatchId = null;
      }
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = (deg) => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    window.routeTo = (lat, lon) => {
      currentDestination = L.latLng(lat, lon);

      if (!userLocation) return alert("Determine your location first.");
      if (routingControl) map.removeControl(routingControl);

      routingControl = L.Routing.control({
        waypoints: [userLocation, currentDestination],
        router: L.Routing.osrmv1({
          language: 'en',
          profile: 'driving'
        }),
        lineOptions: { styles: [{ color: "#1d4ed8", weight: 5 }] },
        addWaypoints: false,
        routeWhileDragging: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        createMarker: () => null
      }).addTo(map);

      routingControl.on('routesfound', (e) => {
        const route = e.routes[0];
        const summary = route.summary;

        document.getElementById("nav-distance").textContent =
          (summary.totalDistance / 1000).toFixed(2) + " km";
        document.getElementById("nav-time").textContent =
          Math.round(summary.totalTime / 60) + " min";

        document.getElementById("nav-instruction").textContent =
          route.instructions?.[0]?.text || "Start driving";

        if (geoWatchId) navigator.geolocation.clearWatch(geoWatchId);

        geoWatchId = navigator.geolocation.watchPosition(
          (pos) => {
            const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);
            userLocation = latlng;
            userMarker?.setLatLng(latlng);

            const dest = currentDestination;
            const distToDest = getDistance(latlng.lat, latlng.lng, dest.lat, dest.lng);
            document.getElementById("nav-distance").textContent =
              (distToDest / 1000).toFixed(2) + " km";

            if (distToDest < 30) {
              document.getElementById("nav-instruction").textContent = "üéâ You have arrived!";
              document.getElementById("nav-time").textContent = "0 min";
              navigator.geolocation.clearWatch(geoWatchId);
              return;
            }

            const nearestPoint = route.coordinates.reduce((min, p) => {
              const d = getDistance(latlng.lat, latlng.lng, p.lat, p.lng);
              return d < min.dist ? { point: p, dist: d } : min;
            }, { point: route.coordinates[0], dist: Infinity });

            if (nearestPoint.dist > 50) {
              console.log("üöó Off route detected ‚Äî recalculating...");
              routingControl.setWaypoints([latlng, currentDestination]);
            }
          },
          (err) => console.warn("Geolocation error:", err),
          { enableHighAccuracy: true, maximumAge: 1000 }
        );
      });
    };

    // Authentication
    let currentUser = null;
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const statusEl = document.getElementById("login-status");
    const controlButtons = document.querySelector('.control-buttons');

    loginBtn.onclick = () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      signInWithEmailAndPassword(auth, email, pass)
        .then(() => statusEl.textContent = "‚úÖ Logged in successfully")
        .catch(err => statusEl.textContent = "‚ùå Error: " + err.message);
    };

    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        document.getElementById("email").style.display = "none";
        document.getElementById("password").style.display = "none";
        statusEl.textContent = `Logged in as ${user.email}`;
        controlButtons.style.display = "flex";
      } else {
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        document.getElementById("email").style.display = "inline-block";
        document.getElementById("password").style.display = "inline-block";
        statusEl.textContent = "";
        controlButtons.style.display = "none";
      }
    });

    if (window.innerWidth <= 767) {
      const registerBtn = document.querySelector('.login-container');
      const rotateInfo = document.querySelector('.info');
      const navPanel = document.getElementById('nav-panel');

      if (registerBtn) registerBtn.style.display = 'none';
      if (rotateInfo) rotateInfo.style.display = 'none';
      if (navPanel) navPanel.style.display = 'none'; 
    }

    // üõ∞ Start geolocation automatically
    startGeolocationTracking();
  </script>
</body>

</html>
