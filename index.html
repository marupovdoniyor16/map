<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞—Ä—Ç–∞ –æ—Ç–µ–ª–µ–π —Å Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

  <style>
    html, body {
  height: 100%;
  margin: 0;
  font-family: "Segoe UI", Roboto, sans-serif;
  background-color: #f3f4f6;
}

#map {
  height: 100%;
  width: 100%;
}

/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ –æ–∫–Ω–æ */
#info {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(255, 255, 255, 0.95);
  padding: 10px 15px;
  border-radius: 10px;
  font-size: 14px;
  z-index: 1000;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  color: #333;
  font-weight: 500;
}

/* –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */

.control-buttons {
  position: absolute;
  bottom: 90px;
  left: 10px;
  z-index: 1001;
  display: flex;
  flex-direction: row;
  gap: 10px;
  background: rgba(255, 255, 255, 0.95);
  padding: 10px 12px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}


/* –ö–Ω–æ–ø–∫–∏ */
button {
  cursor: pointer;
  padding: 8px 12px;
  font-size: 14px;
  border: none;
  border-radius: 6px;
  background: linear-gradient(135deg, #4f46e5, #3b82f6);
  color: white;
  font-weight: 600;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
  transition: transform 0.2s, box-shadow 0.2s;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
}

button:active {
  transform: scale(0.98);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

/* –ü–æ–∏—Å–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
.search-panel {
  position: absolute;
  top: 100px;
  right: 10px;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  gap: 8px;
  background: rgba(255, 255, 255, 0.95);
  padding: 10px 15px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

#searchInput {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  outline: none;
  width: 160px;
  transition: border-color 0.2s;
}

#searchInput:focus {
  border-color: #3b82f6;
}

/* –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ */
#login-container {
  position: absolute;
  bottom: 10px;
  right: 10px;
  background: rgba(255, 255, 255, 0.95);
  padding: 12px 18px;
  border-radius: 10px;
  font-size: 14px;
  z-index: 1002;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  text-align: center;
  width: 200px;
}

#login-container h4 {
  margin: 5px 0 10px;
  color: #374151;
}

#login-container input {
  width: 90%;
  margin-bottom: 8px;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  outline: none;
  transition: border-color 0.2s;
}

#login-container input:focus {
  border-color: #3b82f6;
}

#login-container button {
  width: 95%;
  margin-top: 5px;
  background: linear-gradient(135deg, #10b981, #059669);
}

#login-container button:hover {
    transform: translateY(-2px);
  }

  #login-status {
    margin-top: 8px;
    color: #059669;
    font-weight: 500;
    font-size: 13px;
  }
  .hotel-label span {
    background: rgba(255, 255, 255, 0.9);
    color: #1f2937;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
    transform: translateY(-10px);
  }
  #nav-panel {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(37, 99, 235, 0.95);
    color: #fff;
    padding: 10px 15px;
    font-size: 15px;
    font-weight: 600;
    text-align: center;
    z-index: 1200;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
  }
  #nav-panel span {
    font-weight: 500;
  }


  </style>
</head>

<body>
  <div id="map"></div>
  <div id="info">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...</div>
  <div id="nav-panel">
  üöó <span id="nav-instruction">–ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</span><br>
  üìè <span id="nav-distance">‚Äì</span> | ‚è±Ô∏è <span id="nav-time">‚Äì</span>
  </div>


  <div class="control-buttons">
    <button id="addBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–µ–ª—å</button>
    <button id="delBtn">üóë –£–¥–∞–ª–∏—Ç—å –æ—Ç–µ–ª—å</button>
  </div>

  <div class="search-panel">
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –æ—Ç–µ–ª—è..." style="padding: 5px;" />
    <button id="searchBtn">üîç –ù–∞–π—Ç–∏</button>
  </div>

  <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
  <!-- –§–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div id="login-container">
    <h4>–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h4>
    <input type="email" id="email" placeholder="Email" style="width:150px; margin-bottom:5px;"><br>
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" style="width:150px; margin-bottom:5px;"><br>
    <button id="login-btn" style="width:160px; padding:5px;">–í–æ–π—Ç–∏</button>
    <button id="logout-btn" style="width:160px; padding:5px; display:none;">–í—ã–π—Ç–∏</button>
    <p id="login-status" style="margin-top:5px; color:green; font-size:12px;"></p>
  </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getDatabase, ref, push, remove, onChildAdded, onChildRemoved, onValue } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDeXC4WPwuwYh82tJe61gdLWBUVPOYjJKQ",
      authDomain: "hotelmapapppc.firebaseapp.com",
      databaseURL: "https://hotelmapapppc-default-rtdb.firebaseio.com",
      projectId: "hotelmapapppc",
      storageBucket: "hotelmapapppc.appspot.com",
      messagingSenderId: "706995119297",
      appId: "1:706995119297:web:706f5c81bb91beefeee040"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // –ö–∞—Ä—Ç–∞
    const map = L.map("map").setView([39.66, 66.97], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    const hotelsRef = ref(db, "hotels");
    const hotelMarkers = {};
    let addMode = false, deleteMode = false;
    let userLocation = null, userMarker = null, routingControl = null;

    // --- –ú–µ—Ç–∫–∏ ---
    // --- –ú–µ—Ç–∫–∏ ---
    onChildAdded(hotelsRef, (snapshot) => {
      const id = snapshot.key;
      const hotel = snapshot.val();

      // –û—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ä–∫–µ—Ä
      const marker = L.marker([hotel.lat, hotel.lon]).addTo(map)
        .bindPopup(`
          <b>${hotel.name}</b><br>${hotel.description || "‚Äî"}<br>
          <button onclick="window.routeTo(${hotel.lat}, ${hotel.lon})">–ú–∞—Ä—à—Ä—É—Ç</button>
        `);

      // –ü–æ–¥–ø–∏—Å—å –Ω–∞–¥ –º–∞—Ä–∫–µ—Ä–æ–º
      const label = L.divIcon({
        className: "hotel-label",
        html: `<span>${hotel.name}</span>`,
        iconSize: [100, 20],
        iconAnchor: [50, 30] // —á—Ç–æ–±—ã –±—ã–ª–æ –Ω–∞–¥ —Ç–æ—á–∫–æ–π
      });

      const labelMarker = L.marker([hotel.lat, hotel.lon], {
        icon: label,
        interactive: false // —á—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å—å –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∞ –∫–ª–∏–∫–∏
      }).addTo(map);

      // –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
      marker.on("click", () => {
        if (deleteMode && confirm(`–£–¥–∞–ª–∏—Ç—å ${hotel.name}?`)) {
          remove(ref(db, "hotels/" + id));
        }
      });

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–∞ –º–∞—Ä–∫–µ—Ä–∞
      hotelMarkers[id] = { main: marker, label: labelMarker };
    });

    onChildRemoved(hotelsRef, (snapshot) => {
      const id = snapshot.key;
      if (hotelMarkers[id]) {
        map.removeLayer(hotelMarkers[id].main);
        map.removeLayer(hotelMarkers[id].label);
        delete hotelMarkers[id];
      }
    });


    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–µ–ª—è
    document.getElementById("addBtn").onclick = () => {
      if (!currentUser) { alert("–í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä."); return; }
      addMode = true;
      deleteMode = false;
      alert("–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–µ–ª—å.");
    };

    map.on("click", (e) => {
      if (!addMode) return;
      const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–µ–ª—è:");
      if (name) {
        push(hotelsRef, { name, lat: e.latlng.lat, lon: e.latlng.lng, description: "‚Äî" });
      }
      addMode = false;
    });

    document.getElementById("delBtn").onclick = () => {
      if (!currentUser) { alert("–í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä."); return; }
      deleteMode = true;
      addMode = false;
      alert("–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –æ—Ç–µ–ª—é, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –µ–≥–æ.");
    };

    // –ü–æ–∏—Å–∫
    document.getElementById("searchBtn").onclick = () => {
      const query = document.getElementById("searchInput").value.toLowerCase();
      onValue(hotelsRef, (snapshot) => {
        let found = null;
        snapshot.forEach((child) => {
          const h = child.val();
          if (h.name.toLowerCase().includes(query)) found = h;
        });
        if (found) {
          map.setView([found.lat, found.lon], 16);
        } else alert("–û—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
      });
    };

    // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
    // === –ì–ï–û–õ–û–ö–ê–¶–ò–Ø –ü–û–°–õ–ï –í–•–û–î–ê ===
const personIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/149/149071.png",
  iconSize: [40, 40],
  iconAnchor: [20, 40]
});


let firstLocation = true;

// –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
function startGeolocationTracking() {
  if (!navigator.geolocation) {
    alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.");
    return;
  }

  geoWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);
      userLocation = latlng;

      // –ï—Å–ª–∏ –º–∞—Ä–∫–µ—Ä –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω ‚Äî —Å–æ–∑–¥–∞—ë–º –µ–≥–æ
      if (!userMarker) {
        userMarker = L.marker(latlng, { icon: personIcon })
          .addTo(map)
          .bindPopup("–í—ã –∑–¥–µ—Å—å")
          .openPopup();
      } else {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–ª–∞–≤–Ω–æ
        userMarker.setLatLng(latlng);
      }

      // –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ ‚Äî –∏—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π –æ—Ç–µ–ª—å –∏ —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
      if (firstLocation) {
        map.setView(latlng, 14);

        onValue(hotelsRef, (snapshot) => {
          let nearest = null;
          let minDist = Infinity;

          snapshot.forEach((child) => {
            const hotel = child.val();
            const dist = getDistance(latlng.lat, latlng.lng, hotel.lat, hotel.lon);
            if (dist < minDist) {
              minDist = dist;
              nearest = hotel;
            }
          });

          if (nearest) {
            window.routeTo(nearest.lat, nearest.lon);
            L.popup()
              .setLatLng([nearest.lat, nearest.lon])
              .setContent(
                `<b>–ë–ª–∏–∂–∞–π—à–∏–π –æ—Ç–µ–ª—å:</b><br>${nearest.name}<br>üìç –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${Math.round(minDist)} –º`
              )
              .openOn(map);
          }
        });

        firstLocation = false;
      }
    },
    (err) => {
      alert("–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è: " + err.message);
    },
    { enableHighAccuracy: true, maximumAge: 1000 }
  );
}

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
function stopGeolocationTracking() {
  if (geoWatchId !== null) {
    navigator.geolocation.clearWatch(geoWatchId);
    geoWatchId = null;
  }
}


    // --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–≤ –º–µ—Ç—Ä–∞—Ö) ---
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // —Ä–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö
      const toRad = (deg) => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }


   let geoWatchId = null;
let currentDestination = null;

window.routeTo = (lat, lon) => {
  currentDestination = L.latLng(lat, lon);

  if (!userLocation) return alert("–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.");
  if (routingControl) map.removeControl(routingControl);

  routingControl = L.Routing.control({
    waypoints: [userLocation, currentDestination],
    router: L.Routing.osrmv1({
      language: 'ru',
      profile: 'driving'
    }),
    lineOptions: { styles: [{ color: "#1d4ed8", weight: 5 }] },
    addWaypoints: false,
    routeWhileDragging: false,
    draggableWaypoints: false,
    fitSelectedRoutes: true,
    createMarker: () => null
  }).addTo(map);

  routingControl.on('routesfound', (e) => {
    const route = e.routes[0];
    const summary = route.summary;

    document.getElementById("nav-distance").textContent =
      (summary.totalDistance / 1000).toFixed(2) + " –∫–º";
    document.getElementById("nav-time").textContent =
      Math.round(summary.totalTime / 60) + " –º–∏–Ω";

    document.getElementById("nav-instruction").textContent =
      route.instructions?.[0]?.text || "–ù–∞—á–∏–Ω–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ";

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
    if (geoWatchId) navigator.geolocation.clearWatch(geoWatchId);

    geoWatchId = navigator.geolocation.watchPosition(
      (pos) => {
        const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);
        userLocation = latlng;
        userMarker?.setLatLng(latlng);

        const dest = currentDestination;
        const distToDest = getDistance(latlng.lat, latlng.lng, dest.lat, dest.lng);
        document.getElementById("nav-distance").textContent =
          (distToDest / 1000).toFixed(2) + " –∫–º";

        if (distToDest < 30) {
          document.getElementById("nav-instruction").textContent = "üéâ –í—ã –ø—Ä–∏–±—ã–ª–∏ –≤ –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è!";
          document.getElementById("nav-time").textContent = "0 –º–∏–Ω";
          navigator.geolocation.clearWatch(geoWatchId);
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–∫–ª–æ–Ω–∏–ª—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const nearestPoint = route.coordinates.reduce((min, p) => {
          const d = getDistance(latlng.lat, latlng.lng, p.lat, p.lng);
          return d < min.dist ? { point: p, dist: d } : min;
        }, { point: route.coordinates[0], dist: Infinity });

        if (nearestPoint.dist > 50) {
          console.log("üöó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª—Å—è –æ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ ‚Äî –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º...");
          // –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –æ—Ç –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
          routingControl.setWaypoints([latlng, currentDestination]);
        }
      },
      (err) => console.warn("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:", err),
      { enableHighAccuracy: true, maximumAge: 1000 }
    );
  });

  routingControl.on('routeselected', (e) => {
    const route = e.route;
    const first = route.instructions?.[0];
    if (first) {
      document.getElementById("nav-instruction").textContent = first.text;
    }
  });
};



    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    let currentUser = null;
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const statusEl = document.getElementById("login-status");

    loginBtn.onclick = () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      signInWithEmailAndPassword(auth, email, pass)
        .then(() => statusEl.textContent = "‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω")
        .catch(err => statusEl.textContent = "‚ùå –û—à–∏–±–∫–∞: " + err.message);
    };

    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
  currentUser = user;
  if (user) {
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    document.getElementById("email").style.display = "none";
    document.getElementById("password").style.display = "none";
    statusEl.textContent = `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ ${user.email}`;
  } else {
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    document.getElementById("email").style.display = "inline-block";
    document.getElementById("password").style.display = "inline-block";
    statusEl.textContent = "";
  }
});

// üõ∞Ô∏è –°—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
startGeolocationTracking();


  </script>
</body>
</html>
